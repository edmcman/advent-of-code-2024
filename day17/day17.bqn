NN â† (>âŸœÂ«0âŠ¸â‰¤) / 0(0âŠ¸â‰¤Ã—Ã—âŸœ10âŠ¸+)`âŠ¢
ToNats â† { NN 10âŠ¸â‰¤âŠ¸(Â¬âŠ¸Ã—-âŠ£) ğ•©-'0' }

in â† (ToNatsâ€¢file.Bytes) "input.txt"
âŸ¨a,b,câŸ©â€¿prog â† ((3âŠ¸â†‘)â‹ˆ((âˆ˜â€¿2âŠ¸â¥Š)âˆ˜(3âŠ¸â†“))) in

ToBin â† 2{ğ•©=0?â†•0;(ğ•ŠâŒŠğ•©Ã·ğ•—)âˆ¾ğ•—|ğ•©}
FromBin â† 2âŠ¸Ã—âŠ¸+ËœÂ´âŒ½

MkState â† {ğ•ŠâŸ¨a,b,câŸ©â€¿prog:
    aâ€¿bâ€¿câ€¿prog â‡
    pc â‡ 0
    output â‡ âŸ¨âŸ©
    IncPC â† {ğ•Š: pc â†© pc+1 }
    GetCombo â† {
        âŠ‘ğ•©âˆŠ[0,1,2,3] ? ğ•© ;
        ğ•©â‰¡4 ? a ;
        ğ•©â‰¡5 ? b ;
        ğ•©â‰¡6 ? c ;
        !0
    }
    Print â† {ğ•Š:
        â€¢Show "a" â‹ˆ a
        â€¢Show "b" â‹ˆ b
        â€¢Show "c" â‹ˆ c
    }
    Step â‡ {ğ•Š:
        opcodeâ€¿op â† pc âŠ prog
        {
            # adv
            opcodeâ‰¡0 ? {
                num â† a
                div â† 2â‹†GetCombo op
                a â†© âŒŠnum Ã· div
            } ;
            # bxl
            opcode=1 ? {
                b â†© âŠ‘ [8 | b] 8â€¢bit._xor (8 | op)
            } ;
            # bst
            opcode=2 ? {
                b â†© 8 | GetCombo op
            } ;
            # jnz
            opcode=3 ? {
                {aâ‰¢0 ? pc â†© op Ã· 2; IncPC @}
            } ;
            # bxc
            opcode=4 ? {
                b â†© âŠ‘ [8 | b] 8â€¢bit._xor (8 | c)
            } ;
            # out
            opcode=5 ? {
                output â†© output âˆ¾ 8 | GetCombo op
            } ;
            # bdv
            opcode=6 ? {
                num â† a
                div â† 2â‹†GetCombo op
                b â†© âŒŠnum Ã· div
            } ;
            # cdv
            opcode=7 ? {
                num â† a
                div â† 2â‹†GetCombo op
                c â†© âŒŠnum Ã· div
            } ; !
        }
        # for all but opcode 3, advance pc
        {opcodeâ‰ 3 ? IncPC @ ; @}
    }
    Done â‡ {ğ•Š: pc â‰¥ â‰ prog}
    Run â‡ {ğ•Š: Step â€¢_while_ (Â¬âˆ˜Done) @
        output
    }
}

Join â† {1â†“â¥Šğ•¨â‰Ë˜ğ•©}

part1 â†  ',' Join '0' + (MkState âŸ¨a,b,câŸ©â€¿prog).Run @

# Start with last byte and work forward

Part2 â† {prog ğ•Š inâ€¿n:

    goal â† âŒ½ (n+1)â†‘ âŒ½â¥Šprog
    solns â† / (<goal) â‰¡Â¨ {ğ•Š: (MkState âŸ¨in+ğ•©,0,0âŸ©â€¿prog).Run @}Â¨ (â†•8)

    {goalâ‰¡â¥Šprog ? â€¢Show "GOAL!" â‹„ in + solns ;

    # shift left by 3 bits
    âŸ¨âŸ© âˆ¾Â´ {prog Part2 ğ•©â€¿(n+1)}Â¨ (8 Ã— (in + solns))
}}

p2s â† prog Part2 0â€¿0
p2 â† âŒŠÂ´ p2s

st â† MkState âŸ¨p2,0,0âŸ©â€¿prog
st.Run @
#â€¢Show st.output
#â€¢Show prog
!st.output â‰¡ â¥Šprog

